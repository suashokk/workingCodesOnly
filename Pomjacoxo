<plugin>
  <groupId>org.jacoco</groupId>
  <artifactId>jacoco-maven-plugin</artifactId>
  <version>0.8.11</version>

  <executions>

    <!-- 1️⃣ Attach agent -->
    <execution>
      <id>prepare-agent</id>
      <goals>
        <goal>prepare-agent</goal>
      </goals>
    </execution>

    <!-- 2️⃣ Generate report (THIS WAS MISSING) -->
    <execution>
      <id>report</id>
      <phase>verify</phase>
      <goals>
        <goal>report</goal>
      </goals>
    </execution>

    <!-- 3️⃣ Enforce coverage -->
    <execution>
      <id>check</id>
      <phase>verify</phase>
      <goals>
        <goal>check</goal>
      </goals>

      <configuration>
        <rules>
          <rule>
            <element>BUNDLE</element>
            <limits>

              <limit>
                <counter>INSTRUCTION</counter>
                <value>COVEREDRATIO</value>
                <minimum>0.80</minimum>
              </limit>

              <limit>
                <counter>BRANCH</counter>
                <value>COVEREDRATIO</value>
                <minimum>0.70</minimum>
              </limit>

            </limits>
          </rule>
        </rules>

        <excludes>
          <exclude>**/config/**</exclude>
          <exclude>**/dto/**</exclude>
          <exclude>**/model/**</exclude>
          <exclude>**/constants/**</exclude>
          <exclude>**/exception/**</exclude>
          <exclude>**/*Application.class</exclude>
        </excludes>

      </configuration>
    </execution>

  </executions>
</plugin>
